AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: (fiap-feedback-notifier) - Notificação de Feedback Crítico (MS2)

Parameters:
  SenderEmail:
    Type: String
    Description: "O endereço de e-mail verificado no SES para enviar as notificações."
    Default: "emmanuellaf.albuquerque@gmail.com" # Seu email para testes

Globals:
  Function:
    Runtime: java17
    Timeout: 30
    MemorySize: 512
    Architectures:
      - x86_64

Resources:

  ## =========================
  ## Lambda - Urgency Notification Worker
  ## =========================
  UrgencyNotificationWorkerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: ms2-urgency-notification-worker
      Runtime: java17
      Handler: io.quarkus.amazon.lambda.runtime.QuarkusStreamHandler
      CodeUri: target/function.zip

      Environment:
        Variables:
          QUARKUS_LAMBDA_HANDLER: urgencyNotificationWorker
          # Importa o ARN do tópico SNS da stack compartilhada
          URGENT_TOPIC_ARN: !ImportValue UrgencyTopicArn
          REPORT_TOPIC_ARN: !ImportValue ReportTopicArn
          REPORT_SUBSCRIPTION_TOPIC_ARN: !ImportValue ReportSubscriptionTopicArn
          SENDER_EMAIL: !Ref SenderEmail

      Policies:
        - SQSPollerPolicy: # Permite ler do SQS (usando o nome da fila, que o SAM resolve se estiver na mesma conta/região)
            QueueName: FilaUrgencia
        
        - Statement: # Permissão para listar inscritos no tópico SNS importado
            Effect: Allow
            Action:
              - sns:ListSubscriptionsByTopic
            Resource: !ImportValue UrgencyTopicArn
            
        - Statement: # Permissão SES para enviar e-mail
            Effect: Allow
            Action:
              - ses:SendEmail
              - ses:SendRawEmail
            Resource: "*"

      Events:
        SQSTrigger:
          Type: SQS
          Properties:
            # Importa o ARN da fila SQS da stack compartilhada
            Queue: !ImportValue FilaUrgenciaArn
            BatchSize: 10


  ## =========================
  ## Lambda - Report Notification Worker
  ## =========================
  ReportNotificationWorkerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: ms2-report-notification-worker
      Runtime: java17
      Handler: io.quarkus.amazon.lambda.runtime.QuarkusStreamHandler
      CodeUri: target/function.zip

      Environment:
        Variables:
          QUARKUS_LAMBDA_HANDLER: reportNotificationWorker
          # Importa o ARN do tópico SNS da stack compartilhada
          REPORT_TOPIC_ARN: !ImportValue ReportTopicArn
          URGENT_TOPIC_ARN: !ImportValue UrgencyTopicArn
          REPORT_SUBSCRIPTION_TOPIC_ARN: !ImportValue ReportSubscriptionTopicArn
          SENDER_EMAIL: !Ref SenderEmail

      Policies:
        - Statement: # Permissão para listar inscritos no tópico SNS importado
            Effect: Allow
            Action:
              - sns:ListSubscriptionsByTopic
            Resource: !ImportValue ReportSubscriptionTopicArn

        - Statement: # Permissão SES para enviar e-mail
            Effect: Allow
            Action:
              - ses:SendEmail
              - ses:SendRawEmail
            Resource: "*"

        - Statement: # Permissão S3 para baixar relatórios
            Effect: Allow
            Action:
              - s3:GetObject
            Resource: "*"

      Events:
        ReportSNSTrigger:
          Type: SNS
          Properties:
            Topic: !ImportValue ReportTopicArn

  ## =================================
  ## SES - Identidade de E-mail
  ## =================================
  SenderEmailIdentity:
    Type: AWS::SES::EmailIdentity
    Properties:
      EmailIdentity: !Ref SenderEmail
